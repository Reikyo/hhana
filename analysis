#!/usr/bin/env python

from mva.cmd import get_parser

args = get_parser().parse_args()
year = args.year

# stdlib imports
import pickle
from pprint import pprint
import os

# rootpy imports
from rootpy.plotting import Hist
from rootpy.io import open as ropen

# root imports
import ROOT

# numpy imports
import numpy as np

# local imports
from mva import log, variables, plots_dir, samples
from mva.plotting import *
from mva.samples import *
from mva.utils import make_multipage_pdf
from mva.norm import qcd_ztautau_norm
from mva.classify import *
from mva.systematics import SYSTEMATICS
from mva.categories import MassRegions, CATEGORIES
from mva.variables import VARIABLES


PLOTS_DIR = plots_dir(__file__)

if args.embedding:
    ztautau = Embedded_Ztautau(
            year=year,
            systematics=args.systematics)
else:
    ztautau = MC_Ztautau(
            year=year,
            systematics=args.systematics)
others = Others(
        year=year,
        systematics=args.systematics)
data = Data(
        year=year,
        markersize=1.2)

higgs_125 = Higgs(
        year=year,
        mass=125,
        systematics=args.systematics,
        scale=50,
        linecolor='red')

figures = {}
category_scores = {}

output_suffix = '_%sfit' % args.fit_param
if args.embedding:
    output_suffix += '_embedding'
if args.suffix:
    output_suffix += '_%s' % args.suffix
output_suffix += '_%d' % (year % 1E3)

mass_regions = MassRegions(
        low=args.low_mass_cut,
        high=args.high_mass_cut,
        high_sideband_in_control=args.high_sideband_in_control)

control_region = mass_regions.control_region
signal_region = mass_regions.signal_region
train_region = mass_regions.train_region

for category, cat_info in sorted(CATEGORIES.items(), key=lambda item: item[0]):

    if category not in args.categories:
        continue

    log.info("")
    log.info("=" * 40)
    log.info("%s category" % category)
    log.info("=" * 40)
    log.info("Cuts: %s" % cat_info['cuts'])
    
    # QCD shape region SS or !OS
    qcd_shape_region = cat_info['qcd_shape_region']
    target_region = cat_info['target_region']
    
    figures[category] = {}

    qcd = QCD(data=data, mc=[others, ztautau],
          shape_region=qcd_shape_region)
    
    qcd.scale = 1.
    ztautau.scale = 1.

    # determine normalization of QCD and Ztautau
    # in each category separately
    qcd_ztautau_norm(
        year=year,
        ztautau=ztautau,
        others=others,
        qcd=qcd,
        data=data,
        category=category,
        target_region=target_region,
        mass_regions=mass_regions,
        bins=cat_info['fitbins'],
        draw=args.draw_fit,
        use_cache=args.use_fit_cache,
        param=args.fit_param,
        systematics=SYSTEMATICS.values() if args.systematics else None,
        root=args.root)
    
    if 'plot' in args.actions:
        cuts = Cut(args.plot_cut)

        if args.plot_expr is not None:
            VARS = {tuple(args.plot_expr.split(',')):
                    {'title': args.plot_name,
                     'range': (args.plot_min, args.plot_max),
                     'bins': args.plot_bins,
                     'cats': ['GGF'],
                     'filename': 'expr_' + args.plot_name.replace(' ', '_')}}
        else:
            VARS = VARIABLES

        for expr, var_info in VARS.items():

            if category in args.categories and category.upper() not in var_info['cats']:
                continue
            elif args.plots and expr not in args.plots:
                continue

            log.info("")
            log.info("plotting %s in %s category" % (expr, category))
            log.info(cat_info['cuts'] & cuts)

            bins = var_info['bins']
            min, max = var_info['range']

            if 'scale' in var_info:
                expr = "%s * %f" % (expr, var_info['scale'])

            other_hist = others.draw(
                    expr,
                    category, target_region,
                    bins, min, max,
                    cuts=cuts)

            qcd_hist = qcd.draw(
                    expr,
                    category, target_region,
                    bins, min, max,
                    cuts=cuts)

            ztautau_hist = ztautau.draw(
                    expr,
                    category, target_region,
                    bins, min, max,
                    cuts=cuts)

            bkg_hists = [qcd_hist, other_hist, ztautau_hist]
            
            signal_hist = higgs_125.draw(
                    expr,
                    category, target_region,
                    bins, min, max,
                    cuts=cuts)

            if not var_info.get('blind', False):

                data_hist = data.draw(
                        expr,
                        category, target_region,
                        bins, min, max,
                        cuts=cuts)
                
                log.info("Data events: %d" % sum(data_hist))
                log.info("Model events: %f" % sum(sum(bkg_hists)))
                for hist in bkg_hists:
                    log.info("{0} {1}".format(hist.GetTitle(), sum(hist)))
                log.info("Signal events: %f" % sum(signal_hist))
                log.info("Data / Model: %f" % (sum(data_hist) /
                    sum(sum(bkg_hists))))
            else:
                data_hist = None
            
            output_name = var_info['filename'] + output_suffix
            if cuts:
                output_name += '_' + cuts.safe()

            fig = draw(
                    data=data_hist,
                    model=bkg_hists,
                    signal=signal_hist,
                    name=var_info['root'] if args.root else var_info['title'],
                    output_name=output_name,
                    category_name=cat_info['name'],
                    category=category,
                    units=var_info.get('units', None),
                    range=var_info['range'],
                    show_ratio=True,
                    show_qq=False,
                    plot_signal_significance=False,
                    dir=PLOTS_DIR,
                    systematics=SYSTEMATICS.values() if args.systematics else None,
                    root=args.root,
                    output_formats=args.output_formats)
            figures[category][expr] = fig

    if 'train' in args.actions:

        backgrounds = [
            qcd,
            others,
            ztautau,
        ]
        
        # all modes, all masses
        signals_train = [
            Higgs(
                year=year,
                #mass=125,
                systematics=args.systematics),
        ]

        # define training and test samples
        branches = cat_info['features']
        spectators = [
            'mass_mmc_tau1_tau2',
        ]
        
        clf = ClassificationProblem(
                signals=signals_train,
                backgrounds=backgrounds,
                fields=branches,
                category=category,
                category_name=cat_info['name'],
                region=target_region,
                cuts=None,
                output_suffix=output_suffix,
                spectators=spectators)
        
        clf.correlations()

        clf.train(
                grid_search=args.grid_search,
                quick=args.quick_train,
                cv_nfold=args.nfold,
                use_cache=args.use_clf_cache)
        
        bkg_scores, sig_scores = clf.evaluate(
                data,
                mass_regions,
                unblind=args.unblind,
                systematics=args.systematics,
                bins=args.bins,
                limitbins=cat_info['limitbins'],
                limitbinning=cat_info['limitbinning'],
                quick=True)

        category_scores[category] = (bkg_scores, sig_scores)


if 'train' in args.actions and set(args.categories) == set(CATEGORIES.keys()):
    # draw ROC curves for all categories
    hist_template = Hist(100, -1, 1)
    from matplotlib import pyplot as plt
    plt.figure()
    for category, (bkg_scores, sig_scores) in category_scores.items():
        bkg_hist = hist_template.Clone()
        sig_hist = hist_template.Clone()
        hist_scores(bkg_hist, bkg_scores)
        hist_scores(sig_hist, sig_scores)
        bkg_array = np.array(bkg_hist)
        sig_array = np.array(sig_hist)
        # reverse cumsum
        bkg_eff = bkg_array[::-1].cumsum()[::-1] 
        sig_eff = sig_array[::-1].cumsum()[::-1]
        bkg_eff /= bkg_array.sum()
        sig_eff /= sig_array.sum()
        plt.plot(sig_eff, 1. - bkg_eff,
                 linestyle='-',
                 linewidth=2.,
                 label=category)
    plt.legend(loc='lower left')
    plt.ylabel('Background Rejection')
    plt.xlabel('Signal Efficiency')
    plt.ylim(0, 1)
    plt.xlim(0, 1)
    plt.grid()
    plt.savefig('ROC.png', bbox_inches='tight')
    

# save all variable plots in one large multipage pdf
if figures and set(args.categories) == set(CATEGORIES.keys()) and not args.plots:
    # only create multipage pdf of all plots if we created all plots
    for category, exprs in figures.items():
        figs = sorted(exprs.items(), key=lambda x: x[0])
        make_multipage_pdf([fig[1] for fig in figs], name=category,
                dir=PLOTS_DIR)
