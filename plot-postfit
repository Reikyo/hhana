#!/usr/bin/env python
# python imports
import os
import pickle
# ROOT/rootpy imports
from ROOT import TLatex, TGraphAsymmErrors 
from rootpy import asrootpy
from rootpy.io import root_open
from rootpy.plotting import Canvas, HistStack, Legend, set_style
from rootpy.plotting.utils import draw
from rootpy.plotting.style.atlas import ATLAS_style, ATLAS_label
# local imports
from mva.categories import CATEGORIES
from mva.analysis import Analysis
from statstools import log; log = log[__name__]
from statstools.postfit import FitModel, ModelCalculator
from statstools.jobs import run_pool
from statstools.postfit_plot import (UncertGraph, get_binning,
                                     get_rebinned_graph, get_rebinned_hist)

# ------------------------------
def Fit_WS(workspace, output_basename='frames', n_jobs=1):
    """
    Fit the WS and compute the histograms and TGraphAssymErrors
    for the final plotting drawing
    Parameters
    ----------
    workspace : RooWorkspace
        HSG4 like workspace
    """
    # --> Get the Model Config object
    mc = workspace.obj("ModelConfig")
    if not mc:
        raise RuntimeError('Could not retrieve the ModelConfig object')
    # --> Get the data distribution
    obsData = workspace.data('obsData')
    if not obsData:
        raise RuntimeError('Could not retrieve the data distribution')
    workspace.saveSnapshot('StartingPoint', mc.GetPdf().getParameters(obsData))
    roo_min = workspace.fit()
    fit_res = roo_min.save()

    # --> parameter of interest (mu=sigma/sigma_sm)
    poi =  mc.GetParametersOfInterest().first()
    poi_fitted_val = poi.getVal()
    log.info('POI: {0} = {1} +/- {2}'.format(poi.GetName(), poi.getVal(), poi.getError()))

    output_root = output_basename + '.root'
    output_pickle = output_basename + '.pickle'
    log.info('Output: {0}'.format(output_root))
    root_open(output_root, 'recreate')

    workers = []
    for cat in mc.GetPdf():
        log.info('retrieve plotting objects of {0} ...'.format(cat.name))
        model = FitModel(mc, obsData, cat)
        workers.append(ModelCalculator(model, fit_res, output_root, output_pickle))
    run_pool(workers, n_jobs=n_jobs)
        

# ---------------------------------
def plot_from_frame(file, frame, fit_var, binning):
    """
    """
    Ana = Analysis(2012)

    # ---------------------------------
    hbkg = file.Get('h_sum_bkg_{0}'.format(frame.GetName()))
    curve_uncert_bkg = frame.getCurve('FitError_AfterFit_sum_bkg_{0}'.format(frame.GetName()))
    graph_bkg_ws = UncertGraph(hbkg, curve_uncert_bkg)
    graph_bkg = get_rebinned_graph(graph_bkg_ws, binning) 
    graph_bkg.fillstyle='//'
    graph_bkg.color='black'
    graph_bkg.title = 'Uncert.'
    graph_bkg.legendstyle = 'F'

    # --------------------------------
    data_ws = frame.getHist('Data')
    # HACK HACK HACK
    data_ws.__class__=TGraphAsymmErrors
    data = get_rebinned_graph(asrootpy(data_ws), binning)
    data.SetTitle('Data')
    # --------------------------------
    hist_fake_ws = file.Get('h_Fakes_{0}'.format(frame.GetName()))
    hist_fake = get_rebinned_hist(hist_fake_ws, binning)
    hist_fake.color = Ana.qcd.hist_decor['color']
    hist_fake.fillstyle = 'solid'
    hist_fake.title = Ana.qcd.label
    hist_fake.legendstyle = 'F'
    
    # --------------------------------
    hist_others_ws = file.Get('h_Others_{0}'.format(frame.GetName()))
    hist_others = get_rebinned_hist(hist_others_ws, binning)
    hist_others.color = Ana.others.hist_decor['color']
    hist_others.fillstyle = 'solid'
    hist_others.title = Ana.others.label
    hist_others.legendstyle = 'F'

    # --------------------------------
    hist_ztautau_ws = file.Get('h_Ztautau_{0}'.format(frame.GetName()))
    hist_ztautau = get_rebinned_hist(hist_ztautau_ws, binning)
    hist_ztautau.color = Ana.ztautau.hist_decor['color']
    hist_ztautau.fillstyle = 'solid'
    hist_ztautau.title = Ana.ztautau.label
    hist_ztautau.legendstyle = 'F'
    
    # --------------------------------
    hist_signal_ws = file.Get('h_sum_sig_{0}'.format(frame.GetName()))
    hist_signal = get_rebinned_hist(hist_signal_ws, binning)
    hist_signal.color = Ana.higgs_125.hist_decor['linecolor']
    hist_signal.linestyle = 'solid'
    hist_signal.linewidth = 4
    hist_signal.title = Ana.higgs_125.label+ ' (best fit #mu)'
    hist_signal.legendstyle = 'F'
    
    Model = HistStack(hists=[hist_fake, hist_others,
                             hist_ztautau, hist_signal],
                      name='Model_{0}'.format(frame.GetName()))

    plotables = [Model]
    if fit_var=='bdt_score':
        xtitle = 'BDT Score'
        categories = CATEGORIES['mva']
        logy = True
    else:
        xtitle='MMC MASS [GeV]'
        categories=CATEGORIES['cuts']+CATEGORIES['cuts_2011']
        logy = False
    c = Canvas()
    draw(plotables, pad=c, ypadding=(0.3, 0.3),
         xtitle=xtitle, ytitle= 'Events', logy=logy)
    if '_11' in frame.GetName():
        text='Internal 2011'
        sqrts=7
    else:
        text='Internal 2012'
        sqrts=8
        
    ATLAS_label(0.2, 0.89, pad=c, sep=0.132, text=text, sqrts=sqrts)
    graph_bkg.Draw('sameE2')
    data.Draw('samePE')

    leg = Legend([data]+Model.GetHists()+[graph_bkg],
                 rightmargin=0.2,
                 margin=0.35,
                 topmargin=0.01,
                 textsize=20,
                 entrysep=0.02,
                 entryheight=0.04)
    leg.Draw()
    label_name = None
    for cat in categories:
        if cat.name in frame.GetName():
            label_name = cat.label
        
    latex = TLatex(0.2, 0.85, label_name)
    latex.SetNDC()
    latex.SetTextSize(20)
    latex.Draw()
    c.RedrawAxis()
    if fit_var == 'bdt_score':
        c.SetLogy()
    return c


if __name__ == '__main__':
    from rootpy.extern.argparse import ArgumentParser
    parser = ArgumentParser()
    parser.add_argument('file')
    parser.add_argument('--name', default='combined')
    parser.add_argument('--fit-var', default='bdt_score', choices=['bdt_score', 'mmc_mass'])
    parser.add_argument('--force-fit', action='store_true', default=False)
    parser.add_argument('--jobs', default=1)
    args = parser.parse_args()


    if args.fit_var=='bdt_score':
        categories = CATEGORIES['mva']
    else:
        categories = CATEGORIES['cuts']+CATEGORIES['cuts_2011']

    output = os.path.splitext(args.file)[0]
    output += '_postfit'
    if args.force_fit:
        with root_open(args.file) as file:
            Fit_WS(file[args.name], output, n_jobs=args.jobs)

    set_style('ATLAS', shape='rect')
    with root_open(output+'.root') as file:
        for _, _, names in file.walk(class_pattern='*RooPlot*'):
            for name in names:
                if 'rest' in name:
                    continue
                log.info('Channel: {0}'.format(name))
                # hbkg = file.Get('h_sum_bkg_{0}'.format(file[name].GetName()))
                # log.info('{0}: x: {1}'.format(hbkg.name, list(hbkg.xedges())))
                # log.info('{0}: y: {1}'.format(hbkg.name, list(hbkg.y())))
                binning = get_binning(name, categories, fit_var=args.fit_var)
                canvas = plot_from_frame(file, file[name], args.fit_var, binning)
                canvas.SaveAs('plots/postfit_{0}.png'.format(name))
