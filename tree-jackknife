#!/usr/bin/env python
# 
from rootpy.io import root_open
import numpy as np
from numpy.lib import recfunctions
from root_numpy import array2tree
# local imports
from mva.cmd import get_parser
from mva.analysis import get_analysis
from mva.categories import *
args = get_parser(actions=False).parse_args()
analysis = get_analysis(args)


def get_record_overlap(data, mva_cat, target_region, fields, cba_cat):
    rec = data.merged_records(mva_cat, target_region,
                              fields=fields, include_weight=False, cuts=cb_cat.cuts)
    rec.dtype.names = names
    jks_mva = [mva_cat.jk_number for i in range(0, len(rec))]
    jks_cba = [cba_cat.jk_number for i in range(0, len(rec))]
    rec = recfunctions.rec_append_fields(rec, data=jks_mva, names='catMVA', dtypes='i8')
    rec = recfunctions.rec_append_fields(rec, data=jks_cba, names='catCBA', dtypes='i8')
    ismva = [1 for i in range(0, len(rec))]
    iscba = [0 for i in range(0, len(rec))]
    rec = recfunctions.rec_append_fields(rec, data=ismva, names='IsMVA', dtypes='i8')
    rec = recfunctions.rec_append_fields(rec, data=iscba, names='IsCBA', dtypes='i8')
    return rec


CB = CATEGORIES['cuts']
MVA = CATEGORIES['mva_all']


fields = ['EventNumber', 'mmc1_mass', 'dEta_tau1_tau2']
names = ('EvtNum', 'MMC', 'DETA')

target_region = args.target_region
data = analysis.data
#category = Category_Preselection

recs = []
for category in analysis.iter_categories(
    args.categories, args.controls, names=args.category_names):
    for cb_cat in CB:
        rec = get_record_overlap(data, category, target_region, fields, cb_cat)
        recs.append(rec)


big_rec = np.concatenate(recs)
out = root_open('hh_jackknife.root', 'recreate')
out.cd()
output_name = 'datatree'
outtree = array2tree(big_rec, name='datatree') 
outtree.Write()
out.Close()

